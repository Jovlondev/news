{% extends 'base.html' %}
{% load static %}
{% block title %} News|View{% endblock %}
{% block extra_style %}
<style>
	.comment-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
    }

    .comment-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
    }

     .comment-item {
            list-style: none;
            margin-bottom: 20px;
     }

     .comment-image {
            float: left;
            margin-right: 15px;
     }

     .comment-image img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
     }

     .comment-info {
            overflow: hidden;
     }

     .comment-author {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
     }

     .comment-text {
            margin: 10px 0;
            color: #555;
            line-height: 1.6;
     }

     .comment-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
     }

     .comment-divider {
            border: 0;
            border-top: 1px solid #eee;
            margin: 10px 0;
     }

     .sub-comments {
            margin-left: 60px;
            list-style: none;
     }

     .reply-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
     }

     .reply-button:hover {
            background-color: #2980b9;
     }

     .add-comment-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
     }

     .add-comment-button:hover {
            background-color: #27ae60;
     }

     .comment-form {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
     }

     .comment-form input,
     .comment-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
     }

     .comment-form input {
            height: 40px;
     }

     .comment-form textarea {
            height: 100px;
            resize: vertical;
     }

     .comment-form button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
     }

     .comment-form button:hover {
            background-color: #2980b9;
     }

     .add-info-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
     }
</style>
{% endblock %}

{% block content %}
	<div class="container wrapper">
		<div class="longrek"></div>
		<div class="clearfix"></div>
		
		<ol class="breadcrumb">
			<li><a href="{% url 'home' %}">Bosh sahifa</a></li>
			<li><a href="{% url 'ctg' slug=one_new.ctg.name%}">{{ one_new.ctg.name }}</a></li>
			<li class="active">{{ one_new.title }}</li>
		</ol>
		<div class="row">
			<div class="col-md-8 col-xs-12">
				<div class="view_img"><img src="{{ one_new.image1.url }}" alt=""></div>
				<div class="news_box view">
					<div class="view_title">{{ one_new.title }}</div>
					<span class="date">{{ one_new.get_date }}</span>
					<span class="news_type"><i class="fa fa-book"></i>{{ one_new.ctg.name }}</span>
					<span class="news_type"><i class="fa fa-eye"></i>{{ one_new.ctg.views }}</span>
					<div class="view_desc">
					<p> {{ one_new.short_desc }} </p>
					{% if one_new.image2  %}
					<div id="bigfav" class="carousel slide view_slide" data-ride="carousel">
						<div class="carousel-inner" role="listbox">
							<div class="item active">
								<img src="{{ one_new.image1.url }}" alt="...">
							</div>
						</div>
					</div>
					{% endif %}
						<p>{{ one_new.description }}</p>
				</div>
				<ul class="tag">
					{% for i in one_new.get_tags %}
					<li><a href="#">{{ i }}</a></li>
					{% endfor %}
				</ul>
				{% if random_news %}
				<div class="nav_news">
						<a href="{% url 'view' pk=random_news.0.id %}" class="prev_news text-right">
							<i class="fa fa-angle-left"></i>
							{{ random_news.0.title }}
						</a>
						<a href="{% url 'view' pk=random_news.1.id %}" class="next_news">
							{{ random_news.1.title }}
							<i class="fa fa-angle-right"></i>
						</a>
						<div class="clearfix"></div>
					</div>
				{% endif %}
				<div class="comment-container">
					<div class="comment-title">Izohlar <sup>{{ count }}</sup></div>
					<ul class="comment-list">
						{% for i in comments %}
						<li class="comment-item">
							<div class="comment-info">
								<div class="comment-author">{{ i.user }}</div>
								<p class="comment-text">{{ i.message }}</p>
								<div class="comment-date">{{ i.get_date }}</div>
								<button class="reply-button" onclick="toggleReplyForm(this)"></button>
								<div class="comment-form reply-form" >
									<form class="comment-form" method="post">
										{% csrf_token %}
										<input type="text" name="Ism" placeholder="Ism" class="form-input" >
										<input type="number" name="parent_id" value="{{ i.id }}" placeholder="Ism" class="form-input" hidden>
										<textarea  name="message" class="form-textarea" placeholder="Xabar" ></textarea>
										<button type="submit" class="form-submit" onclick="submitReply(this)">Yuborish</button>
									</form>
								</div>
								<hr class="comment-divider">
							</div>
							{% if i.subs.all%}
							<ul class="sub-comments">
								{% for sub in subs %}
								<li class="comment-item">
									<div class="comment-info">
										<div class="comment-author">{{ sub.user }}</div>
										<p class="comment-text">{{ sub.message }}</p>
										<div class="comment-date">{{ sub.get_date }}</div>
										<button class="reply-button" onclick="toggleReplyForm(this)">Javob berish</button>
										<hr class="comment-divider">
									</div>
								</li>
								{% endfor %}
							</ul>
							{% endif %}
						</li>
						{% endfor %}
					</ul>
					<button class="add-comment-button" onclick="toggleCommentForm()">Добавить комментарий</button>
					<form class="comment-form" id="mainCommentForm" method="post" >
						{% csrf_token %}
						<input type="text" name="user" placeholder="Ism" class="form-input">
						<textarea name="message" placeholder="Xabar" class="form-textarea"></textarea>
						<button type="submit" class="form-submit" onclick="submitComment()">Yuborish</button>
					</form>
					<div class="add-info-text">Приветствуются интересные и осмысленные комментарии по теме материала.</div>
				</div>
				</div>
			</div>
				<div class="col-md-4 col-xs-12">
					<div class="head_title">Eng sara yangliklar</div>
					<div id="listnews" class="carousel slide listnews" data-ride="carousel">
						<div class="news_box">
							<div class="carousel-inner" role="listbox">
								<div class="item active">
									<ul class="list_news">
										{% for i in svejiy_news%}
										{% if forloop.counter < 5 %}
										<li>
											<div class="list_img"><img src="{{ i.image1.url }}" alt=""></div>
											<a href="#">{{ i.short_desc}}</a>
											<span class="date">{{ i.get_date }}</span>
										</li>
										{% endif %}
										{% endfor %}

									</ul>
								</div>
								<div class="item">
									<ul class="list_news">
										{% for i in svejiy_news%}
										{% if forloop.counter > 4 and forloop.counter < 9 %}
										<li>
											<div class="list_img"><img src="{{ i.image1.url }}" alt=""></div>
											<a href="#">{{ i.short_desc}}</a>
											<span class="date">{{ i.get_date }}</span>
										</li>
										{% endif %}
										{% endfor %}
									</ul>
								</div>
							</div>
						</div>
						<div class="indi_box">
							<ol class="carousel-indicators">
								<li data-target="#listnews" data-slide-to="0" class="active"></li>
								<li data-target="#listnews" data-slide-to="1"></li>
							</ol>
						</div>
					</div>

					<div class="news_box rek">
						<div class="rek_right">

						</div>
					</div>
					<div class="subscribe">
						<div class="title">Sytimizga: <b>1news.uz</b></div>
						<form action="{% url 'subs_add' path='view' %}" method="post">
							{% csrf_token %}
							<div class="input-group">
								<input type="text" name="email" placeholder="Email" required>
								<button class="submit">Obuna bo'lish</button>
							</div>
						</form>
					</div>
				</div>
		</div>
	</div>
{% endblock %}


{% block extra_js %}
<script>
	// Javob berish formasini ko‘rsatish/yashirish
function toggleReplyForm(button) {
    const replyForm = button.nextElementSibling; // Reply formasi buttondan keyin keladi
    const isVisible = replyForm.style.display === 'block';

    // Barcha reply formalarni yashirish
    document.querySelectorAll('.reply-form').forEach(form => {
        form.style.display = 'none';
    });

    // Agar forma ko‘rinmasa, uni ko‘rsatish, aks holda yashirish
    replyForm.style.display = isVisible ? 'none' : 'block';
}

// Umumiy komment qo‘shish formasini ko‘rsatish/yashirish
function toggleCommentForm() {
    const commentForm = document.getElementById('mainCommentForm');
    const isVisible = commentForm.style.display === 'block';

    // Formani ko‘rsatish yoki yashirish
    commentForm.style.display = isVisible ? 'none' : 'block';
}

// Javob berish formasini yuborish
function submitReply(button) {
    const form = button.closest('form');
    const formData = new FormData(form);

    // Ma'lumotlarni serverga yuborish (AJAX orqali)
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken') // CSRF tokenini qo'shish
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Muvaffaqiyatli yuborilganda formani yashirish va sahifani yangilash
            form.closest('.reply-form').style.display = 'none';
            alert('Javob muvaffaqiyatli yuborildi!');
            // Sahifani yangilash yoki yangi kommentni dinamik ravishda qo'shish mumkin
            location.reload(); // Bu yerni o'zingizning logikangizga moslashtirishingiz mumkin
        } else {
            alert('Xatolik yuz berdi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Xatolik:', error);
        alert('Server bilan bog‘lanishda xatolik yuz berdi.');
    });
}

// Umumiy komment qo‘shish formasini yuborish
function submitComment() {
    const form = document.getElementById('mainCommentForm');
    const formData = new FormData(form);

    // Ma'lumotlarni serverga yuborish (AJAX orqali)
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken') // CSRF tokenini qo'shish
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Muvaffaqiyatli yuborilganda formani tozalash va yashirish
            form.reset();
            form.style.display = 'none';
            alert('Komment muvaffaqiyatli qo‘shildi!');
            // Sahifani yangilash yoki yangi kommentni dinamik ravishda qo'shish mumkin
            location.reload(); // Bu yerni o'zingizning logikangizga moslashtirishingiz mumkin
        } else {
            alert('Xatolik yuz berdi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Xatolik:', error);
        alert('Server bilan bog‘lanishda xatolik yuz berdi.');
    });
}

// Sahifa yuklanganda barcha reply formalarni yashirish
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.reply-form').forEach(form => {
        form.style.display = 'none';
    });
    // Agar umumiy komment formasi dastlab yashirin bo‘lishi kerak bo‘lsa
    document.getElementById('mainCommentForm').style.display = 'none';
});


</script>
{% endblock %}